# ACM实验室数据库系统说明

## 概述

本系统已从内存存储升级为 SQLite 数据库持久化存储，确保所有数据的长久保存。

## 数据库结构

### 核心表结构

1. **users** - 用户表
   - `id`: 主键
   - `username`: 用户名（唯一）
   - `password`: 密码哈希
   - `role`: 角色（默认 admin）
   - `display_name`: 显示名称
   - `avatar`: 头像URL
   - `created_at`: 创建时间
   - `updated_at`: 更新时间

2. **team_members** - 团队成员表
   - `id`: 主键
   - `name`: 姓名
   - `position`: 职位
   - `description`: 描述
   - `image_url`: 头像URL
   - `qq`: QQ号
   - `wechat`: 微信号
   - `email`: 邮箱
   - `order_index`: 排序索引
   - `created_at`: 创建时间
   - `updated_at`: 更新时间

3. **research_projects** - 研究项目表
   - `id`: 主键
   - `title`: 项目标题
   - `category`: 类别（人工智能、系统、理论、应用）
   - `description`: 描述
   - `members`: 成员列表（JSON格式）
   - `created_at`: 创建时间
   - `updated_at`: 更新时间

4. **papers** - 论文表
   - `id`: 主键
   - `title`: 论文标题
   - `authors`: 作者列表（JSON格式）
   - `journal`: 期刊/会议
   - `year`: 发表年份
   - `abstract`: 摘要
   - `pdf_url`: PDF链接
   - `doi`: DOI
   - `created_at`: 创建时间
   - `updated_at`: 更新时间

5. **algorithms** - 算法表
   - `id`: 主键
   - `title`: 算法标题
   - `category`: 类别
   - `description`: 描述
   - `author`: 作者
   - `complexity`: 复杂度
   - `code_url`: 代码链接
   - `demo_url`: 演示链接
   - `created_at`: 创建时间
   - `updated_at`: 更新时间

6. **innovation_projects** - 科创项目表
   - `id`: 主键
   - `title`: 项目标题
   - `category`: 类别
   - `description`: 描述
   - `team_members`: 团队成员（JSON格式）
   - `status`: 状态（ongoing, completed, paused）
   - `start_date`: 开始日期
   - `end_date`: 结束日期
   - `achievements`: 成果
   - `created_at`: 创建时间
   - `updated_at`: 更新时间

7. **activities** - 动态活动表
   - `id`: 主键
   - `title`: 标题
   - `content`: 内容
   - `category`: 类别
   - `author`: 作者
   - `publish_date`: 发布日期
   - `image_url`: 图片URL
   - `tags`: 标签（JSON格式）
   - `created_at`: 创建时间
   - `updated_at`: 更新时间

## 数据管理工具

### 1. 示例数据初始化

```bash
python init_sample_data.py
```

功能：
- 添加示例团队成员（6位成员）
- 添加示例研究项目（6个项目）
- 添加示例论文（2篇论文）
- 仅在数据库为空时执行，不会重复添加

### 2. 数据库备份工具

```bash
# 备份数据库
python db_backup.py backup

# 列出所有备份
python db_backup.py list

# 恢复数据库
python db_backup.py restore --file backups/acm_lab_backup_20231201_120000.json
```

功能：
- 备份数据到 JSON 格式和 SQLite 文件
- 支持增量备份和完整恢复
- 自动处理JSON字段的序列化/反序列化
- 恢复前自动备份当前数据库

## API接口

### 团队成员 API

- `GET /api/team` - 获取所有团队成员
- `POST /api/team` - 创建新成员（需要管理员权限）
- `PUT /api/team/<id>` - 更新成员信息（需要管理员权限）
- `DELETE /api/team/<id>` - 删除成员（需要管理员权限）

### 研究项目 API

- `GET /api/research` - 获取所有研究项目
- `POST /api/research` - 创建新项目（需要管理员权限）
- `PUT /api/research/<id>` - 更新项目信息（需要管理员权限）
- `DELETE /api/research/<id>` - 删除项目（需要管理员权限）

### 管理员 API

- `GET /api/admin/profile` - 获取管理员资料
- `PUT /api/admin/profile` - 更新管理员资料
- `PUT /api/admin/password` - 修改密码
- `POST /api/admin/avatar` - 上传头像

## 文件结构

```
acm_lab_ai_make/
├── app.py                 # 主应用文件
├── acm_lab.db            # SQLite 数据库文件
├── init_sample_data.py   # 示例数据初始化脚本
├── db_backup.py          # 数据库备份工具
├── backups/              # 备份文件目录
│   ├── acm_lab_backup_*.json
│   └── acm_lab_db_*.sqlite
├── static/
│   └── uploads/
│       └── avatars/      # 管理员头像目录
└── templates/            # 模板文件
```

## 使用说明

### 首次启动

1. 运行应用：`python app.py`
2. 访问：http://127.0.0.1:5000/admin
3. 默认账号：admin / admin123
4. 初始化示例数据（可选）：`python init_sample_data.py`

### 数据管理

1. **查看数据**：通过前端页面或API接口
2. **备份数据**：`python db_backup.py backup`
3. **恢复数据**：`python db_backup.py restore --file <备份文件>`

### 管理员操作

1. **修改个人信息**：后台设置页面
2. **管理团队**：后台团队管理页面
3. **添加内容**：通过各个管理页面

## 注意事项

1. **数据持久化**：所有数据现在都保存在 `acm_lab.db` 文件中
2. **备份重要性**：建议定期备份数据库
3. **权限控制**：只有管理员可以进行增删改操作
4. **会话管理**：登录会话持续1天，支持免登录
5. **文件上传**：头像文件保存在 `static/uploads/avatars/` 目录

## 故障排除

### 数据库损坏

```bash
# 从最近的备份恢复
python db_backup.py list
python db_backup.py restore --file backups/最新备份文件.json
```

### 重置为初始状态

```bash
# 删除数据库文件，重启应用将自动重建
rm acm_lab.db
python app.py
```

### 查看数据库状态

```bash
sqlite3 acm_lab.db ".tables"
sqlite3 acm_lab.db "SELECT COUNT(*) FROM team_members;"
```

## 扩展开发

### 添加新表

1. 在 `init_db()` 函数中添加表创建语句
2. 创建对应的数据库操作函数
3. 添加API路由
4. 更新备份脚本的表列表

### 修改现有表

1. 创建数据库迁移脚本
2. 更新对应的操作函数
3. 测试备份和恢复功能 